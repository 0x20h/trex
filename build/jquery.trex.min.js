/**
 * jquery.trex.js - html5 terminal recordings player based on term.js.
 *
 * Copyright (c) 2013 Jan Kohlhof <kohj@informatik.uni-marburg.de>
 *
 * Permission is hereby granted, free of charge, to any person obtaining a 
 * copy of this software and associated documentation files 
 * (the "Software"), to deal in the Software without restriction, 
 * including without limitation the rights to use, copy, modify, merge, 
 * publish, distribute, sublicense, and/or sell copies of the Software, 
 * and to permit persons to whom the Software is furnished to do so, 
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included 
 * in all copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS 
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF 
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. 
 * IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE 
 * FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF 
 * CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH 
 * THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */
!function(a,b,c,d){function e(b,c){this.element=a(b),this.wrapper=a('<div class="trex-wrapper"></div>'),this.element.append(this.wrapper),this.settings=a.extend({},g,c),this._defaults=g,this._name=f,this.controls={},this.timer=d,this.init()}var f="trex",g={speed:1,auto_start:!1};e.prototype={init:function(){var b=this;return this.session=this.element.data("session"),this.index=[],this.session?void a.getJSON(this.session,{},function(a){b.chunks=a.chunks,b.elapsed=b.chunks.reduce(function(a,b){return a.concat(Number(a[a.length-1])+Number(b[0]))},[0]);var c=0;b.chunks.forEach(function(a,d){b.index[parseInt(c+=Number(a[0]),10)]=d}),b.term=new Terminal({cols:parseInt(a.cols,10),rows:parseInt(a.rows,10),useStyle:!0,screenKeys:!1}),b.term.open(b.wrapper.get(0)),b.reset(),b.initControls(),b.settings.auto_start&&b.tick()}):void console.error("Please provide a session name via thedata-session property.")},tick:function(a){var b=this;if(a||(a=1),this.chunks.length<=this.player.current)return clearTimeout(this.timer),void(this.player.playing&&this.toggle());var c=this.chunks[this.player.current][0],d=function(){for(var c="",d=0;a>d;d++){var e=b.chunks[b.player.current++];c+=e[1]}b.term.write(c),b.element.trigger("tick",[b.player.current]),b.player.playing&&b.tick()};clearTimeout(this.timer),this.timer=setTimeout(d,a>1?0:1e3*c*this.settings.speed)},reset:function(){this.player={current:0,playing:this.player?this.player.playing:!1},clearTimeout(this.timer),this.term.reset()},jump:function(a){a<this.player.current?this.reset():a-=this.player.current,this.tick(a)},toggle:function(){this.player.playing=!this.player.playing,this.player.playing&&(this.chunks.length-1<=this.player.current?this.jump(0):this.tick()),this.element.trigger("toggle")},initControls:function(){{var b=this;a(c)}this._initPlayButton(),this._initSlider(),this._initFullscreen(),this._initTimeInfo();var d=a('<div class="terminal-controls"></div>').append(this.controls.play_pause).append(this.controls.sliderWrapper).append(this.controls.time_info);this.wrapper.prepend(d),this.element.on("mouseenter",function(){clearTimeout(b.controls.fadeout_controls_timer),d.fadeIn("fast")}).on("mouseleave",function(){b.controls.fadeout_controls_timer=setTimeout(function(){d.fadeOut("slow")},1200)}).on("click",function(){b.toggle()})},_initPlayButton:function(){var b=this;this.controls.play_pause=a('<div class="play trex-sprite play-controls"></div>'),this.element.on("toggle",function(){b.controls.play_pause.toggleClass("pause").toggleClass("play")})},_initTimeInfo:function(){var b=this,c=this.elapsed[this.elapsed.length-1],d=this.elapsed[this.player.current],e=function(a){var b=parseInt(a,10),c=Math.floor(b/60),d=b-60*c;return 10>c&&(c="0"+c),10>d&&(d="0"+d),c+":"+d};this.controls.time_info=a('<div class="time-info"><span class="elapsed">'+e(d)+"</span>/"+e(c)+"</div>"),setInterval(function(){b.controls.time_info.find(".elapsed").text(e(b.elapsed[b.player.current]))},1e3)},_initSlider:function(){var b,d=this,e=0,f=a(c),g=function(a){var b=Date.now(),c=b-e>50;if(e=c?b:e,clearTimeout(this.timer),c){clearTimeout(d.controls.fadeout_controls_timer);var f=d.controls.sliderWrapper,g=(a.originalEvent.clientX-f.position().left)/f.width();0>g&&(g=0),g>1&&(g=1),d.jump(parseInt(g*d.chunks.length,10))}},h=function(){f.off("mousemove",g).off("mouseup",h).css({cursor:"auto"}),d.player.playing=b,d.player.playing&&d.tick()};this.controls.sliderWrapper=a('<div class="slider-wrapper"></div>').on("click",function(a){g(a)}).on("mousedown",function(){b=d.player.playing,d.player.playing=!1,f.css({cursor:"pointer"}).on("mousemove",g).on("mouseup",h)}),this.controls.slider=a('<div class="slider"></div>'),this.controls.sliderWrapper.append(this.controls.slider),this.element.on("tick",function(a,b){d.controls.slider.css({width:parseInt(b/d.chunks.length*100,10)+"%"})})},_initFullscreen:function(){var b=this;this.controls.expand=a('<div class="expand screen-controls trex-sprite"></div>').on("click",function(){var c=b.element.get(0),d=a(this);d.hasClass("expand")?(d.toggleClass("expand").toggleClass("shrink"),c.requestFullscreen?c.requestFullscreen():c.mozRequestFullScreen?c.mozRequestFullScreen():c.webkitRequestFullscreen&&c.webkitRequestFullscreen(),b.player.playing||b.toggle()):d.toggleClass("expand").toggleClass("shrink")})}},a.fn[f]=function(b){return this.each(function(){a.data(this,"plugin_"+f)||a.data(this,"plugin_"+f,new e(this,b))})}}(jQuery,window,document);